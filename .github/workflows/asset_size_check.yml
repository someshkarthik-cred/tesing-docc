name: Check File Size
on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

jobs:
  check_file_size:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: List changed files
      id: list_changed_files
      run: |
        echo output_files=$(git diff --name-only origin/${{ github.base_ref }}...origin/${{ github.head_ref }} --diff-filter=ACM -- '*.m4a' '*.mp3' '*.wav' '*.lottie') >> $GITHUB_OUTPUT
    - name: Check file size
      id: bulky_files
      run: |
        echo "File | Size (KB) | Link | Status" > file_table.md
        echo "--- | --- | ---" >> file_table.md
        has_exceeded_limit=0
        for file in ${{ steps.list_changed_files.outputs.output_files }}; do
          file_size=$(du -k "$file" | cut -f1)
          file_link="[Link](https://github.com/${{ github.repository }}/blob/${{ github.head_ref }}/$file)"
          echo "$file | $file_size | $file_link" >> file_table.md
          if [ "$file_size" -gt 100 ]; then
            echo "$file | $file_size | $file_link | FAILED ❌" >> file_table.md
            has_exceeded_limit=1
          else
            echo "$file | $file_size | $file_link | PASSED ✅" >> file_table.md
          fi
        done
        
        if [ $has_exceeded_limit -eq 1 ]; then
        table_output=$(cat file_table.md)
        echo "table_output<<EOF" >> $GITHUB_ENV
        echo "$table_output" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
        echo check_status=1 >> $GITHUB_OUTPUT
        else
        exit 0;
        fi
    - name: Comment on pull request
      uses: actions/github-script@v4
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const table = '${{ env.table }}'
          const { owner, repo, number } = github.context.issue
          const octokit = new github.GitHub(process.env.GITHUB_TOKEN)
          await octokit.issues.createComment({
            owner,
            repo,
            issue_number: number,
            body: `### File Size Report\n\n${table}`
          })
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
