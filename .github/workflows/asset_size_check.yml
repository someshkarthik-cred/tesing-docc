name: Check File Size
on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

jobs:
  check_file_size:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: List changed files
      id: list_changed_files
      run: |
        echo "::set-output name=files::$(git diff --name-only origin/${{ github.base_ref }}...origin/${{ github.head_ref }} --diff-filter=ACM -- '*.m4a' '*.mp3' '*.wav' '*.lottie')"
    - name: Check file size
      run: |
        for file in ${{ steps.list_changed_files.outputs.files }}; do
          file_size=$(du -k "$file" | cut -f1)
          if [ "$file_size" -gt 100 ]; then
            echo "The file $file is larger than 100KB (size: ${file_size}KB)."
            echo "::error::The file $file is larger than 100KB (size: ${file_size}KB). Please reduce the file size before merging."
            exit 1
          else
            echo "The file $file is within the size limit (size: ${file_size}KB)."
          fi
        done
    - name: Post comment
      if: always()
      uses: actions/github-script@v4
      with:
        script: |
          const { data } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.payload.pull_request.number
          })
          const { html_url } = data
          let message = '## File Size Check\n'
          const job = context.payload.workflow.jobs.check_file_size
          for (const step of job.steps) {
            if (step.id === 'check_file_size') {
              message += `### ${step.name}\n`
              message += '```\n'
              message += step.outputs.stdout
              message += '\n```\n'
            }
          }
          if (job.status === 'success') {
            message += '**All files are within the size limit.**'
          } else {
            message += '**Some files are larger than the size limit.**'
          }
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.payload.pull_request.number,
            body: message + `\n\nView the [workflow run](${html_url}) for more details.`
          })
