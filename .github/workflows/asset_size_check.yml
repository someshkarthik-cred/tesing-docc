name: Check File Size
on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

jobs:
  check_file_size:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: List changed files
      id: list_changed_files
      run: |
        echo output_files=$(git diff --name-only origin/${{ github.base_ref }}...origin/${{ github.head_ref }} --diff-filter=ACM -- '*.m4a' '*.mp3' '*.wav' '*.lottie') >> $GITHUB_OUTPUT
    - name: Check file size
      id: bulky_files
      run: |
        file_list=""
        has_exceeded_limit=0
        for file in ${{ steps.list_changed_files.outputs.output_files }}; do
          file_size=$(du -k "$file" | cut -f1)
          if [ "$file_size" -gt 100 ]; then
            file_list+="$file_list| $file | ${file_size}KB | Failed |"
            file_list+="\n"
            has_exceeded_limit=1
          else
            file_list+="$file_list| $file | ${file_size}KB | Passed |"
            file_list+="\n"
          fi
        done
        
        if [ $has_exceeded_limit -eq 1 ]; then
        table_output=$(echo -e "| File | Size | Status |\n| --- | --- | --- |\n$file_list")
        echo $table_output
        echo files=$table_output >> $GITHUB_OUTPUT
        exit 1;
        else
        exit 0;
        fi
    - name: Create comment
      uses: peter-evans/create-or-update-comment@v3
      with:
        body: ${{ steps.bulky_files.outputs.files }}
        issue-number: ${{ github.event.pull_request.number }}
