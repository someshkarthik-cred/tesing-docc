name: Check File Size
on:
  pull_request:
    branches: ["main"]

jobs:
  check_file_size:
    runs-on: self-hosted
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: List changed files
      id: list_changed_files
      run: |
        output_files=$(git diff --name-only origin/${{ github.base_ref }}...origin/${{ github.head_ref }} --diff-filter=ACM -- '*.m4a' '*.mp4' '*.aiff' '*.mp3' '*.wav' '*.json')
        echo "output_files<<EOF" >> $GITHUB_ENV
        echo "$output_files" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
    - name: Check file size
      id: bulky_files
      run: |
        urlencode() {
          # Use awk to URL encode the input string
          echo "$1" | sed 's/ /%20/g'
        }
        
        file_extension() {
          # Use awk to extract the file extension
          extension=`expr "$1" : '.*\.\(.*\)'`
          echo "file format we got $extension"
          echo "$extension"
        }
        
        size_limit() {
          case $1 in
            m4a | mp3 )
              echo 100
              ;;
            json )
              echo 250
            * )
              echo "🚨 Unknown format. please fix the script for any discrepency 🚨"
              exit 1
          esac
        }
        
        echo "File | Size (KB) | extension | Link | Status" > file_table.md
        echo "--- | --- | --- | --- | ---" >> file_table.md
        has_encountered_error=false
        IFS=$'\n'
        while read -r file; do
          file_size=$(du -k "$file" | cut -f1)
          file_link="[Link](https://github.com/${{ github.repository }}/blob/${{ github.head_ref }}/$file)"
          encoded_url=$(urlencode "$file_link")
          extension=$(file_extension "$file_link")
          if [[ "$file" =~ \.(wav|mp4|aiff)$ ]]; then
            export has_encountered_error=true
            echo "$file | $file_size | $extension | $encoded_url | UNSUPPORTED_FILE_FORMAT ❌" >> file_table.md
          else
            if [ "$file_size" -gt 100 ]; then
              export has_encountered_error=true
              echo "$file | $file_size | $extension | $encoded_url | FAILED ❌" >> file_table.md
            else
              echo "$file | $file_size | $extension | $encoded_url | PASSED ✅" >> file_table.md
            fi
          fi
        done <<< "${{ env.output_files }}"
        unset IFS
        
        echo "<!-- End of table -->" >> file_table.md
        echo "Supported File formats \`.m4a\`, \`.mp3\`, \`.json\`" >> file_table.md        
        size_table="
          Extension | Size Limit
          --- | ---
          \`.m4a\`, \`mp3\` | 100KB
          \`.json\` | 200KB
        "
        echo "$size_table" >> file_table.md
        echo "<!-- End of table -->" >> file_table.md
        
        if [ "$has_encountered_error" = true ]; then
          echo check_status=1 >> $GITHUB_OUTPUT
        fi
    - name: Comment on PR
      uses: actions/github-script@v4
      continue-on-error: true
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const contents = fs.readFileSync('file_table.md', 'utf8');
          const message = `### File Size Report\n\n${contents}`;
          github.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: message
          });
    - name: check file size status
      run: |
        if [ ${{ steps.bulky_files.outputs.check_status }} -eq 1 ]; then
        echo "### 🚨 We have encoutered few asset size above thresshold. please compress them 🚨 ###"
        echo -e "::error::$(cat file_table.md)"
        #exit 1;
        fi
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
