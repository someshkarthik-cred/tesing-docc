name: Check File Size
on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

jobs:
  check_file_size:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: List changed files
      id: list_changed_files
      run: |
        echo output_files=$(git diff --name-only origin/${{ github.base_ref }}...origin/${{ github.head_ref }} --diff-filter=ACM -- '*.m4a' '*.mp3' '*.wav' '*.lottie') >> $GITHUB_OUTPUT
    - name: Check file size
      id: bulky_files
      run: |
        output=""
        has_exceeded_limit=0
        for file in ${{ steps.list_changed_files.outputs.output_files }}; do
          file_size=$(du -k "$file" | cut -f1)
          if [ "$file_size" -gt 100 ]; then
            echo "The file $file is larger than 100KB (size: ${file_size}KB)."
            echo "::error file=$file,line=1::The file $file is larger than 100KB (size: ${file_size}KB). Please reduce the file size before merging."
            output+="The file $file is larger than 100KB (size: ${file_size}KB). Please reduce the file size before merging\n"
            has_exceeded_limit=1
          else
            echo "The file $file is within the size limit (size: ${file_size}KB)."
          fi
        done
        
        if [ $has_exceeded_limit -eq 1 ]; then
        echo files=$output >> $GITHUB_OUTPUT
        exit 1;
        else
        exit 0;
        fi
    - name: Comment on pull request
      if: ${{ failure() }}
      uses: actions/github-script@v4
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const result = `#### Check File Size\n\n${{ steps.bulky_files.outputs.files }}`;
          const payload = {
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: result
          };
          return github.issues.createComment(payload);
